"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _axios = _interopRequireDefault(require("axios"));

var _debug = _interopRequireDefault(require("debug"));

require("axios-debug-log");

var _fs = _interopRequireDefault(require("fs"));

var _promises = _interopRequireDefault(require("fs/promises"));

var _path = _interopRequireDefault(require("path"));

var _cheerio = _interopRequireDefault(require("cheerio"));

var _PageLoaderNetError = _interopRequireDefault(require("./errors/PageLoaderNetError"));

var _PageLoaderFsError = _interopRequireDefault(require("./errors/PageLoaderFsError"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const debugHttpFiles = (0, _debug.default)('page-loader:http:files');
const debugHttpMain = (0, _debug.default)('page-loader:http:main');
const debugFs = (0, _debug.default)('page-loader:fs:');
const defaultDir = process.cwd();
const tags = ['img', 'link', 'script'];

const createFile = async (source, filepath) => {
  let response;

  try {
    debugHttpFiles('GET %s', source);

    const request = _axios.default.create({
      baseURL: source,
      method: 'GET',
      responseType: 'stream'
    });

    response = await request();
  } catch (e) {
    throw new _PageLoaderNetError.default(e, source);
  }

  try {
    await response.data.pipe(_fs.default.createWriteStream(filepath));
    return true;
  } catch (e) {
    throw new _PageLoaderFsError.default(e, filepath);
  }
};

const getAttrName = tag => {
  switch (tag) {
    case 'img':
      return 'src';

    case 'link':
      return 'href';

    case 'script':
      return 'src';

    default:
      throw new Error('Unknown tag name');
  }
};

const getName = url => {
  const nameFromHostName = `${url.hostname.split('.').join('-')}`;
  const nameFromPath = url.pathname.length > 1 ? `${url.pathname.split('/').join('-')}` : '';
  return `${nameFromHostName}${nameFromPath}`;
};

const getFilePath = (sourceUrl, baseUrl) => {
  const name = `${getName(baseUrl)}_files/${getName(sourceUrl)}`;
  const isSourceDirectory = _path.default.extname(sourceUrl.href) === '';
  return isSourceDirectory ? `${name}.html` : name;
};

const getSourcesInfo = (html, tagNames, baseUrl) => {
  const foundLinks = tagNames.reduce((acc, tag) => {
    const links = [];

    _cheerio.default.load(html)(tag).each((i, el) => {
      links[i] = {
        tag,
        origin: (0, _cheerio.default)(el).attr(getAttrName(tag))
      };
    });

    return [...acc, ...links];
  }, []);
  const linksForComparison = foundLinks.map(link => ({ ...link,
    normalized: new URL(link.origin, baseUrl)
  }));
  const localLinks = linksForComparison.filter(({
    normalized,
    origin
  }) => origin && normalized.host === baseUrl.host);
  return localLinks.map(item => ({ ...item,
    newFilePath: getFilePath(item.normalized, baseUrl)
  }));
};

const getNewHtml = (sourcesData, html) => {
  const $ = _cheerio.default.load(html);

  sourcesData.forEach(({
    tag,
    origin,
    newFilePath
  }) => {
    const attrName = getAttrName(tag);
    $(`${tag}[${attrName}="${origin}"]`).attr(attrName, newFilePath);
  });
  return $.html();
};

var _default = async (requestUrl, dir = defaultDir) => {
  const url = new URL(requestUrl);
  const pageName = getName(url);
  const filepath = `${dir}/${pageName}.html`;
  const filesDirName = `${dir}/${pageName}_files`;
  let html;
  let newHtml;
  let filesSource;

  try {
    debugHttpMain('GET %s', url.href);
    const {
      data
    } = await _axios.default.get(url.href);
    html = data;
  } catch (e) {
    throw new _PageLoaderNetError.default(e, url.href);
  }

  try {
    filesSource = getSourcesInfo(html, tags, url);
    newHtml = getNewHtml(filesSource, html);
  } catch (e) {
    throw new Error('Failed to parse loaded data. Write us, please');
  }

  try {
    await _promises.default.access(_path.default.dirname(dir));
    await _promises.default.mkdir(dir, {
      recursive: true
    });
  } catch (e) {
    throw new _PageLoaderFsError.default(e, _path.default.dirname(dir));
  }

  try {
    debugFs('Create file %s', filepath, dir);
    await _promises.default.writeFile(filepath, newHtml, 'utf-8');
  } catch (e) {
    throw new _PageLoaderFsError.default(e, dir);
  }

  try {
    debugFs('Create directory %s', filesDirName);
    await _promises.default.mkdir(filesDirName, {
      recursive: true
    });
  } catch (e) {
    throw new _PageLoaderFsError.default(e, dir);
  }

  filesSource.forEach(item => {
    createFile(item.normalized.href, `${dir}/${item.newFilePath}`);
  });
  return filepath;
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2FwcC9hcHAuanMiXSwibmFtZXMiOlsiZGVidWdIdHRwRmlsZXMiLCJkZWJ1Z0h0dHBNYWluIiwiZGVidWdGcyIsImRlZmF1bHREaXIiLCJwcm9jZXNzIiwiY3dkIiwidGFncyIsImNyZWF0ZUZpbGUiLCJzb3VyY2UiLCJmaWxlcGF0aCIsInJlc3BvbnNlIiwicmVxdWVzdCIsImF4aW9zIiwiY3JlYXRlIiwiYmFzZVVSTCIsIm1ldGhvZCIsInJlc3BvbnNlVHlwZSIsImUiLCJQYWdlTG9hZGVyTmV0RXJyb3IiLCJkYXRhIiwicGlwZSIsImZzIiwiY3JlYXRlV3JpdGVTdHJlYW0iLCJQYWdlTG9hZGVyRnNFcnJvciIsImdldEF0dHJOYW1lIiwidGFnIiwiRXJyb3IiLCJnZXROYW1lIiwidXJsIiwibmFtZUZyb21Ib3N0TmFtZSIsImhvc3RuYW1lIiwic3BsaXQiLCJqb2luIiwibmFtZUZyb21QYXRoIiwicGF0aG5hbWUiLCJsZW5ndGgiLCJnZXRGaWxlUGF0aCIsInNvdXJjZVVybCIsImJhc2VVcmwiLCJuYW1lIiwiaXNTb3VyY2VEaXJlY3RvcnkiLCJwYXRoIiwiZXh0bmFtZSIsImhyZWYiLCJnZXRTb3VyY2VzSW5mbyIsImh0bWwiLCJ0YWdOYW1lcyIsImZvdW5kTGlua3MiLCJyZWR1Y2UiLCJhY2MiLCJsaW5rcyIsImNoZWVyaW8iLCJsb2FkIiwiZWFjaCIsImkiLCJlbCIsIm9yaWdpbiIsImF0dHIiLCJsaW5rc0ZvckNvbXBhcmlzb24iLCJtYXAiLCJsaW5rIiwibm9ybWFsaXplZCIsIlVSTCIsImxvY2FsTGlua3MiLCJmaWx0ZXIiLCJob3N0IiwiaXRlbSIsIm5ld0ZpbGVQYXRoIiwiZ2V0TmV3SHRtbCIsInNvdXJjZXNEYXRhIiwiJCIsImZvckVhY2giLCJhdHRyTmFtZSIsInJlcXVlc3RVcmwiLCJkaXIiLCJwYWdlTmFtZSIsImZpbGVzRGlyTmFtZSIsIm5ld0h0bWwiLCJmaWxlc1NvdXJjZSIsImdldCIsInByb21pc2VzIiwiYWNjZXNzIiwi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QWVQLFlBQWYsRUFBNkI7QUFBRVEsTUFBQUEsU0FBUyxFQUFFO0FBQWIsS0FBN0IsQ0FBTjtBQUNELEdBSEQsQ0FHRSxPQUFPbkUsQ0FBUCxFQUFVO0FBQ1YsVUFBTSxJQUFJTSwwQkFBSixDQUFzQk4sQ0FBdEIsRUFBeUJ5RCxHQUF6QixDQUFOO0FBQ0Q7O0FBRURJLEVBQUFBLFdBQVcsQ0FBQ1AsT0FBWixDQUFxQkwsSUFBRCxJQUFVO0FBQzVCM0QsSUFBQUEsVUFBVSxDQUFDMkQsSUFBSSxDQUFDTCxVQUFMLENBQWdCbEIsSUFBakIsRUFBd0IsR0FBRStCLEdBQUksSUFBR1IsSUFBSSxDQUFDQyxXQUFZLEVBQWxELENBQVY7QUFDRCxHQUZEO0FBR0EsU0FBTzFELFFBQVA7QUFDRCxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJztcbmltcG9ydCBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgJ2F4aW9zLWRlYnVnLWxvZyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHByb21pc2VzIGZyb20gJ2ZzL3Byb21pc2VzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGNoZWVyaW8gZnJvbSAnY2hlZXJpbyc7XG5pbXBvcnQgUGFnZUxvYWRlck5ldEVycm9yIGZyb20gJy4vZXJyb3JzL1BhZ2VMb2FkZXJOZXRFcnJvcic7XG5pbXBvcnQgUGFnZUxvYWRlckZzRXJyb3IgZnJvbSAnLi9lcnJvcnMvUGFnZUxvYWRlckZzRXJyb3InO1xuXG5jb25zdCBkZWJ1Z0h0dHBGaWxlcyA9IGRlYnVnKCdwYWdlLWxvYWRlcjpodHRwOmZpbGVzJyk7XG5jb25zdCBkZWJ1Z0h0dHBNYWluID0gZGVidWcoJ3BhZ2UtbG9hZGVyOmh0dHA6bWFpbicpO1xuY29uc3QgZGVidWdGcyA9IGRlYnVnKCdwYWdlLWxvYWRlcjpmczonKTtcblxuY29uc3QgZGVmYXVsdERpciA9IHByb2Nlc3MuY3dkKCk7XG5jb25zdCB0YWdzID0gWydpbWcnLCAnbGluaycsICdzY3JpcHQnXTtcblxuY29uc3QgY3JlYXRlRmlsZSA9IGFzeW5jIChzb3VyY2UsIGZpbGVwYXRoKSA9PiB7XG4gIGxldCByZXNwb25zZTtcbiAgdHJ5IHtcbiAgICBkZWJ1Z0h0dHBGaWxlcygnR0VUICVzJywgc291cmNlKTtcbiAgICBjb25zdCByZXF1ZXN0ID0gYXhpb3MuY3JlYXRlKHtcbiAgICAgIGJhc2VVUkw6IHNvdXJjZSxcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICByZXNwb25zZVR5cGU6ICdzdHJlYW0nLFxuICAgIH0pO1xuICAgIHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdCgpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IFBhZ2VMb2FkZXJOZXRFcnJvcihlLCBzb3VyY2UpO1xuICB9XG4gIHRyeSB7XG4gICAgYXdhaXQgcmVzcG9uc2UuZGF0YS5waXBlKGZzLmNyZWF0ZVdyaXRlU3RyZWFtKGZpbGVwYXRoKSk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgUGFnZUxvYWRlckZzRXJyb3IoZSwgZmlsZXBhdGgpO1xuICB9XG59O1xuXG5jb25zdCBnZXRBdHRyTmFtZSA9ICh0YWcpID0+IHtcbiAgc3dpdGNoICh0YWcpIHtcbiAgICBjYXNlICdpbWcnOlxuICAgICAgcmV0dXJuICdzcmMnO1xuICAgIGNhc2UgJ2xpbmsnOlxuICAgICAgcmV0dXJuICdocmVmJztcbiAgICBjYXNlICdzY3JpcHQnOlxuICAgICAgcmV0dXJuICdzcmMnO1xuICAgIGRlZmF1bHQ6XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gdGFnIG5hbWUnKTtcbiAgfVxufTtcblxuY29uc3QgZ2V0TmFtZSA9ICh1cmwpID0+IHtcbiAgY29uc3QgbmFtZUZyb21Ib3N0TmFtZSA9IGAke3VybC5ob3N0bmFtZS5zcGxpdCgnLicpLmpvaW4oJy0nKX1gO1xuICBjb25zdCBuYW1lRnJvbVBhdGggPSB1cmwucGF0aG5hbWUubGVuZ3RoID4gMSA/IGAke3VybC5wYXRobmFtZS5zcGxpdCgnLycpLmpvaW4oJy0nKX1gIDogJyc7XG4gIHJldHVybiBgJHtuYW1lRnJvbUhvc3ROYW1lfSR7bmFtZUZyb21QYXRofWA7XG59O1xuXG5jb25zdCBnZXRGaWxlUGF0aCA9IChzb3VyY2VVcmwsIGJhc2VVcmwpID0+IHtcbiAgY29uc3QgbmFtZSA9IGAke2dldE5hbWUoYmFzZVVybCl9X2ZpbGVzLyR7Z2V0TmFtZShzb3VyY2VVcmwpfWA7XG4gIGNvbnN0IGlzU291cmNlRGlyZWN0b3J5ID0gcGF0aC5leHRuYW1lKHNvdXJjZVVybC5ocmVmKSA9PT0gJyc7XG4gIHJldHVybiBpc1NvdXJjZURpcmVjdG9yeSA/IGAke25hbWV9Lmh0bWxgIDogbmFtZTtcbn07XG5cbmNvbnN0IGdldFNvdXJjZXNJbmZvID0gKGh0bWwsIHRhZ05hbWVzLCBiYXNlVXJsKSA9PiB7XG4gIGNvbnN0IGZvdW5kTGlua3MgPSB0YWdOYW1lcy5yZWR1Y2UoKGFjYywgdGFnKSA9PiB7XG4gICAgY29uc3QgbGlua3MgPSBbXTtcbiAgICBjaGVlcmlvLmxvYWQoaHRtbCkodGFnKS5lYWNoKChpLCBlbCkgPT4ge1xuICAgICAgbGlua3NbaV0gPSB7IHRhZywgb3JpZ2luOiBjaGVlcmlvKGVsKS5hdHRyKGdldEF0dHJOYW1lKHRhZykpIH07XG4gICAgfSk7XG4gICAgcmV0dXJuIFsuLi5hY2MsIC4uLmxpbmtzXTtcbiAgfSwgW10pO1xuICBjb25zdCBsaW5rc0ZvckNvbXBhcmlzb24gPSBmb3VuZExpbmtzXG4gICAgLm1hcCgobGluaykgPT4gKHsgLi4ubGluaywgbm9ybWFsaXplZDogbmV3IFVSTChsaW5rLm9yaWdpbiwgYmFzZVVybCkgfSkpO1xuICBjb25zdCBsb2NhbExpbmtzID0gbGlua3NGb3JDb21wYXJpc29uXG4gICAgLmZpbHRlcigoeyBub3JtYWxpemVkLCBvcmlnaW4gfSkgPT4gb3JpZ2luICYmIG5vcm1hbGl6ZWQuaG9zdCA9PT0gYmFzZVVybC5ob3N0KTtcbiAgcmV0dXJuIGxvY2FsTGlua3NcbiAgICAubWFwKChpdGVtKSA9PiAoeyAuLi5pdGVtLCBuZXdGaWxlUGF0aDogZ2V0RmlsZVBhdGgoaXRlbS5ub3JtYWxpemVkLCBiYXNlVXJsKSB9KSk7XG59O1xuXG5jb25zdCBnZXROZXdIdG1sID0gKHNvdXJjZXNEYXRhLCBodG1sKSA9PiB7XG4gIGNvbnN0ICQgPSBjaGVlcmlvLmxvYWQoaHRtbCk7XG4gIHNvdXJjZXNEYXRhLmZvckVhY2goKHsgdGFnLCBvcmlnaW4sIG5ld0ZpbGVQYXRoIH0pID0+IHtcbiAgICBjb25zdCBhdHRyTmFtZSA9IGdldEF0dHJOYW1lKHRhZyk7XG4gICAgJChgJHt0YWd9WyR7YXR0ck5hbWV9PVwiJHtvcmlnaW59XCJdYCkuYXR0cihhdHRyTmFtZSwgbmV3RmlsZVBhdGgpO1xuICB9KTtcbiAgcmV0dXJuICQuaHRtbCgpO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgKHJlcXVlc3RVcmwsIGRpciA9IGRlZmF1bHREaXIpID0+IHtcbiAgY29uc3QgdXJsID0gbmV3IFVSTChyZXF1ZXN0VXJsKTtcbiAgY29uc3QgcGFnZU5hbWUgPSBnZXROYW1lKHVybCk7XG4gIGNvbnN0IGZpbGVwYXRoID0gYCR7ZGlyfS8ke3BhZ2VOYW1lfS5odG1sYDtcbiAgY29uc3QgZmlsZXNEaXJOYW1lID0gYCR7ZGlyfS8ke3BhZ2VOYW1lfV9maWxlc2A7XG4gIGxldCBodG1sO1xuICBsZXQgbmV3SHRtbDtcbiAgbGV0IGZpbGVzU291cmNlO1xuXG4gIHRyeSB7XG4gICAgZGVidWdIdHRwTWFpbignR0VUICVzJywgdXJsLmhyZWYpO1xuICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgYXhpb3MuZ2V0KHVybC5ocmVmKTtcbiAgICBodG1sID0gZGF0YTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBQYWdlTG9hZGVyTmV0RXJyb3IoZSwgdXJsLmhyZWYpO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBmaWxlc1NvdXJjZSA9IGdldFNvdXJjZXNJbmZvKGh0bWwsIHRhZ3MsIHVybCk7XG4gICAgbmV3SHRtbCA9IGdldE5ld0h0bWwoZmlsZXNTb3VyY2UsIGh0bWwpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gcGFyc2UgbG9hZGVkIGRhdGEuIFdyaXRlIHVzLCBwbGVhc2UnKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgYXdhaXQgcHJvbWlzZXMuYWNjZXNzKHBhdGguZGlybmFtZShkaXIpKTtcbiAgICBhd2FpdCBwcm9taXNlcy5ta2RpcihkaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IFBhZ2VMb2FkZXJGc0Vycm9yKGUsIHBhdGguZGlybmFtZShkaXIpKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgZGVidWdGcygnQ3JlYXRlIGZpbGUgJXMnLCBmaWxlcGF0aCwgZGlyKTtcbiAgICBhd2FpdCBwcm9taXNlcy53cml0ZUZpbGUoZmlsZXBhdGgsIG5ld0h0bWwsICd1dGYtOCcpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IFBhZ2VMb2FkZXJGc0Vycm9yKGUsIGRpcik7XG4gIH1cblxuICB0cnkge1xuICAgIGRlYnVnRnMoJ0NyZWF0ZSBkaXJlY3RvcnkgJXMnLCBmaWxlc0Rpck5hbWUpO1xuICAgIGF3YWl0IHByb21pc2VzLm1rZGlyKGZpbGVzRGlyTmFtZSwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgUGFnZUxvYWRlckZzRXJyb3IoZSwgZGlyKTtcbiAgfVxuXG4gIGZpbGVzU291cmNlLmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICBjcmVhdGVGaWxlKGl0ZW0ubm9ybWFsaXplZC5ocmVmLCBgJHtkaXJ9LyR7aXRlbS5uZXdGaWxlUGF0aH1gKTtcbiAgfSk7XG4gIHJldHVybiBmaWxlcGF0aDtcbn07XG4iXX0=