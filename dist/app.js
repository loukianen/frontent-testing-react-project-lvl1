"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _axios = _interopRequireDefault(require("axios"));

var _debug = _interopRequireDefault(require("debug"));

require("axios-debug-log");

var _fs = _interopRequireDefault(require("fs"));

var _promises = _interopRequireDefault(require("fs/promises"));

var _path = _interopRequireDefault(require("path"));

var _cheerio = _interopRequireDefault(require("cheerio"));

var _PageLoaderNetError = _interopRequireDefault(require("./errors/PageLoaderNetError"));

var _PageLoaderFsError = _interopRequireDefault(require("./errors/PageLoaderFsError"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const debugCommon = (0, _debug.default)('page-loader');
/*
const debugHttpFiles = debug('page-loader:http:files');
const debugHttpMain = debug('page-loader:http:main');
const debugFs = debug('page-loader:fs:');
*/

const defaultDir = process.cwd();
const tags = ['img', 'link', 'script'];

const createFile = async (source, filepath) => {
  let response;

  try {
    debugCommon('GET %s', source); // debugHttpFiles('GET %s', source);

    const request = _axios.default.create({
      baseURL: source,
      method: 'GET',
      responseType: 'stream'
    });

    response = await request();
  } catch (e) {
    throw new _PageLoaderNetError.default(e, source);
  }

  try {
    debugCommon('Create source file %s', filepath);
    await response.data.pipe(_fs.default.createWriteStream(filepath));
    return true;
  } catch (e) {
    throw new _PageLoaderFsError.default(e, filepath);
  }
};

const getAttrName = tag => {
  switch (tag) {
    case 'img':
      return 'src';

    case 'link':
      return 'href';

    case 'script':
      return 'src';

    default:
      throw new Error('Unknown tag name');
  }
};

const getName = url => {
  const nameFromHostName = `${url.hostname.split('.').join('-')}`;
  const nameFromPath = url.pathname.length > 1 ? `${url.pathname.split('/').join('-')}` : '';
  return `${nameFromHostName}${nameFromPath}`;
};

const getFilePath = (sourceUrl, baseUrl) => {
  const name = `${getName(baseUrl)}_files/${getName(sourceUrl)}`;
  const isSourceDirectory = _path.default.extname(sourceUrl.href) === '';
  return isSourceDirectory ? `${name}.html` : name;
};

const getSourcesInfo = (html, tagNames, baseUrl) => {
  const foundLinks = tagNames.reduce((acc, tag) => {
    const links = [];

    _cheerio.default.load(html)(tag).each((i, el) => {
      links[i] = {
        tag,
        origin: (0, _cheerio.default)(el).attr(getAttrName(tag))
      };
    });

    return [...acc, ...links];
  }, []);
  console.log(foundLinks);
  const linksForComparison = foundLinks.map(link => ({ ...link,
    normalized: new URL(link.origin, baseUrl)
  }));
  const localLinks = linksForComparison.filter(({
    normalized,
    origin
  }) => origin && normalized.host === baseUrl.host);
  return localLinks.map(item => ({ ...item,
    newFilePath: getFilePath(item.normalized, baseUrl)
  }));
};

const getNewHtml = (sourcesData, html) => {
  const $ = _cheerio.default.load(html);

  sourcesData.forEach(({
    tag,
    origin,
    newFilePath
  }) => {
    const attrName = getAttrName(tag);
    $(`${tag}[${attrName}="${origin}"]`).attr(attrName, newFilePath);
  });
  return $.html();
};

var _default = async (requestUrl, dir = defaultDir) => {
  console.log(`defaultDir: ${defaultDir}`);
  console.log(`Dir: ${dir}`);
  const url = new URL(requestUrl);
  const pageName = getName(url);
  const filepath = `${dir}/${pageName}.html`;
  const filesDirName = `${dir}/${pageName}_files`;
  let html;
  let newHtml;
  let filesSource;

  try {
    debugCommon('GET %s', url.href); // debugHttpMain('GET %s', url.href);

    const {
      data
    } = await _axios.default.get(url.href);
    html = data;
    console.log(html);
  } catch (e) {
    throw new _PageLoaderNetError.default(e, url.href);
  }

  try {
    filesSource = getSourcesInfo(html, tags, url);
    console.log(filesSource);
    newHtml = getNewHtml(filesSource, html);
  } catch (e) {
    throw new Error('Failed to parse loaded data. Write us, please');
  }

  try {
    await _promises.default.access(_path.default.dirname(dir));
    await _promises.default.mkdir(dir, {
      recursive: true
    });
  } catch (e) {
    throw new _PageLoaderFsError.default(e, _path.default.dirname(dir));
  }

  try {
    debugCommon('Create file %s', filepath, dir); // debugFs('Create file %s', filepath, dir);

    await _promises.default.writeFile(filepath, newHtml, 'utf-8');
  } catch (e) {
    throw new _PageLoaderFsError.default(e, dir);
  }

  try {
    debugCommon('Create directory %s', filesDirName); // debugFs('Create directory %s', filesDirName);

    await _promises.default.mkdir(filesDirName, {
      recursive: true
    });
  } catch (e) {
    throw new _PageLoaderFsError.default(e, dir);
  }

  filesSource.forEach(item => {
    createFile(item.normalized.href, `${dir}/${item.newFilePath}`);
  });
  return filepath;
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2FwcC9hcHAuanMiXSwibmFtZXMiOlsiZGVidWdDb21tb24iLCJkZWZhdWx0RGlyIiwicHJvY2VzcyIsImN3ZCIsInRhZ3MiLCJjcmVhdGVGaWxlIiwic291cmNlIiwiZmlsZXBhdGgiLCJyZXNwb25zZSIsInJlcXVlc3QiLCJheGlvcyIsImNyZWF0ZSIsImJhc2VVUkwiLCJtZXRob2QiLCJyZXNwb25zZVR5cGUiLCJlIiwiUGFnZUxvYWRlck5ldEVycm9yIiwiZGF0YSIsInBpcGUiLCJmcyIsImNyZWF0ZVdyaXRlU3RyZWFtIiwiUGFnZUxvYWRlckZzRXJyb3IiLCJnZXRBdHRyTmFtZSIsInRhZyIsIkVycm9yIiwiZ2V0TmFtZSIsInVybCIsIm5hbWVGcm9tSG9zdE5hbWUiLCJob3N0bmFtZSIsInNwbGl0Iiwiam9pbiIsIm5hbWVGcm9tUGF0aCIsInBhdGhuYW1lIiwibGVuZ3RoIiwiZ2V0RmlsZVBhdGgiLCJzb3VyY2VVcmwiLCJiYXNlVXJsIiwibmFtZSIsImlzU291cmNlRGlyZWN0b3J5IiwicGF0aCIsImV4dG5hbWUiLCJocmVmIiwiZ2V0U291cmNlc0luZm8iLCJodG1sIiwidGFnTmFtZXMiLCJmb3VuZExpbmtzIiwicmVkdWNlIiwiYWNjIiwibGlua3MiLCJjaGVlcmlvIiwibG9hZCIsImVhY2giLCJpIiwiZWwiLCJvcmlnaW4iLCJhdHRyIiwiY29uc29sZSIsImxvZyIsImxpbmtzRm9yQ29tcGFyaXNvbiIsIm1hcCIsImxpbmsiLCJub3JtYWxpemVkIiwiVVJMIiwibG9jYWxMaW5rcyIsImZpbHRlciIsImhvc3QiLCJpdGVtIiwibmV3RmlsZVBhdGgiLCJnZXROZXdIdG1sIiwic291cmNlc0RhdGEiLCIkIiwiZm9yRWFjaCIsImF0dHJOYW1lIiwicmVxdWVzdFVybCIsImRpciIsInBhZ2VOYW1lIiwiZmlsZXNEaXJOYW1lIiwibmV3SHRtbCIsImZpbGVzU291cmNlIiwiZ2V0IiwicHJvbWlzZXMiLCJhY2Nlc3MiLCJkaXJuYW1lIiwibWtk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QUM5QyxVQUFNTSxrQkFBU0ssU0FBVCxDQUFtQjlFLFFBQW5CLEVBQTZCc0UsT0FBN0IsRUFBc0MsT0FBdEMsQ0FBTjtBQUNELEdBSEQsQ0FHRSxPQUFPOUQsQ0FBUCxFQUFVO0FBQ1YsVUFBTSxJQUFJTSwwQkFBSixDQUFzQk4sQ0FBdEIsRUFBeUIyRCxHQUF6QixDQUFOO0FBQ0Q7O0FBRUQsTUFBSTtBQUNGMUUsSUFBQUEsV0FBVyxDQUFDLHFCQUFELEVBQXdCNEUsWUFBeEIsQ0FBWCxDQURFLENBQ2dEOztBQUNsRCxVQUFNSSxrQkFBU0csS0FBVCxDQUFlUCxZQUFmLEVBQTZCO0FBQUVRLE1BQUFBLFNBQVMsRUFBRTtBQUFiLEtBQTdCLENBQU47QUFDRCxHQUhELENBR0UsT0FBT3JFLENBQVAsRUFBVTtBQUNWLFVBQU0sSUFBSU0sMEJBQUosQ0FBc0JOLENBQXRCLEVBQXlCMkQsR0FBekIsQ0FBTjtBQUNEOztBQUVESSxFQUFBQSxXQUFXLENBQUNQLE9BQVosQ0FBcUJMLElBQUQsSUFBVTtBQUM1QjdELElBQUFBLFVBQVUsQ0FBQzZELElBQUksQ0FBQ0wsVUFBTCxDQUFnQnBCLElBQWpCLEVBQXdCLEdBQUVpQyxHQUFJLElBQUdSLElBQUksQ0FBQ0MsV0FBWSxFQUFsRCxDQUFWO0FBQ0QsR0FGRDtBQUdBLFNBQU81RCxRQUFQO0FBQ0QsQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBheGlvcyBmcm9tICdheGlvcyc7XG5pbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0ICdheGlvcy1kZWJ1Zy1sb2cnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBwcm9taXNlcyBmcm9tICdmcy9wcm9taXNlcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBjaGVlcmlvIGZyb20gJ2NoZWVyaW8nO1xuaW1wb3J0IFBhZ2VMb2FkZXJOZXRFcnJvciBmcm9tICcuL2Vycm9ycy9QYWdlTG9hZGVyTmV0RXJyb3InO1xuaW1wb3J0IFBhZ2VMb2FkZXJGc0Vycm9yIGZyb20gJy4vZXJyb3JzL1BhZ2VMb2FkZXJGc0Vycm9yJztcblxuY29uc3QgZGVidWdDb21tb24gPSBkZWJ1ZygncGFnZS1sb2FkZXInKTtcbi8qXG5jb25zdCBkZWJ1Z0h0dHBGaWxlcyA9IGRlYnVnKCdwYWdlLWxvYWRlcjpodHRwOmZpbGVzJyk7XG5jb25zdCBkZWJ1Z0h0dHBNYWluID0gZGVidWcoJ3BhZ2UtbG9hZGVyOmh0dHA6bWFpbicpO1xuY29uc3QgZGVidWdGcyA9IGRlYnVnKCdwYWdlLWxvYWRlcjpmczonKTtcbiovXG5cbmNvbnN0IGRlZmF1bHREaXIgPSBwcm9jZXNzLmN3ZCgpO1xuY29uc3QgdGFncyA9IFsnaW1nJywgJ2xpbmsnLCAnc2NyaXB0J107XG5cbmNvbnN0IGNyZWF0ZUZpbGUgPSBhc3luYyAoc291cmNlLCBmaWxlcGF0aCkgPT4ge1xuICBsZXQgcmVzcG9uc2U7XG4gIHRyeSB7XG4gICAgZGVidWdDb21tb24oJ0dFVCAlcycsIHNvdXJjZSk7IC8vIGRlYnVnSHR0cEZpbGVzKCdHRVQgJXMnLCBzb3VyY2UpO1xuICAgIGNvbnN0IHJlcXVlc3QgPSBheGlvcy5jcmVhdGUoe1xuICAgICAgYmFzZVVSTDogc291cmNlLFxuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIHJlc3BvbnNlVHlwZTogJ3N0cmVhbScsXG4gICAgfSk7XG4gICAgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgUGFnZUxvYWRlck5ldEVycm9yKGUsIHNvdXJjZSk7XG4gIH1cbiAgdHJ5IHtcbiAgICBkZWJ1Z0NvbW1vbignQ3JlYXRlIHNvdXJjZSBmaWxlICVzJywgZmlsZXBhdGgpO1xuICAgIGF3YWl0IHJlc3BvbnNlLmRhdGEucGlwZShmcy5jcmVhdGVXcml0ZVN0cmVhbShmaWxlcGF0aCkpO1xuICAgIHJldHVybiB0cnVlO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IFBhZ2VMb2FkZXJGc0Vycm9yKGUsIGZpbGVwYXRoKTtcbiAgfVxufTtcblxuY29uc3QgZ2V0QXR0ck5hbWUgPSAodGFnKSA9PiB7XG4gIHN3aXRjaCAodGFnKSB7XG4gICAgY2FzZSAnaW1nJzpcbiAgICAgIHJldHVybiAnc3JjJztcbiAgICBjYXNlICdsaW5rJzpcbiAgICAgIHJldHVybiAnaHJlZic7XG4gICAgY2FzZSAnc2NyaXB0JzpcbiAgICAgIHJldHVybiAnc3JjJztcbiAgICBkZWZhdWx0OlxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHRhZyBuYW1lJyk7XG4gIH1cbn07XG5cbmNvbnN0IGdldE5hbWUgPSAodXJsKSA9PiB7XG4gIGNvbnN0IG5hbWVGcm9tSG9zdE5hbWUgPSBgJHt1cmwuaG9zdG5hbWUuc3BsaXQoJy4nKS5qb2luKCctJyl9YDtcbiAgY29uc3QgbmFtZUZyb21QYXRoID0gdXJsLnBhdGhuYW1lLmxlbmd0aCA+IDEgPyBgJHt1cmwucGF0aG5hbWUuc3BsaXQoJy8nKS5qb2luKCctJyl9YCA6ICcnO1xuICByZXR1cm4gYCR7bmFtZUZyb21Ib3N0TmFtZX0ke25hbWVGcm9tUGF0aH1gO1xufTtcblxuY29uc3QgZ2V0RmlsZVBhdGggPSAoc291cmNlVXJsLCBiYXNlVXJsKSA9PiB7XG4gIGNvbnN0IG5hbWUgPSBgJHtnZXROYW1lKGJhc2VVcmwpfV9maWxlcy8ke2dldE5hbWUoc291cmNlVXJsKX1gO1xuICBjb25zdCBpc1NvdXJjZURpcmVjdG9yeSA9IHBhdGguZXh0bmFtZShzb3VyY2VVcmwuaHJlZikgPT09ICcnO1xuICByZXR1cm4gaXNTb3VyY2VEaXJlY3RvcnkgPyBgJHtuYW1lfS5odG1sYCA6IG5hbWU7XG59O1xuXG5jb25zdCBnZXRTb3VyY2VzSW5mbyA9IChodG1sLCB0YWdOYW1lcywgYmFzZVVybCkgPT4ge1xuICBjb25zdCBmb3VuZExpbmtzID0gdGFnTmFtZXMucmVkdWNlKChhY2MsIHRhZykgPT4ge1xuICAgIGNvbnN0IGxpbmtzID0gW107XG4gICAgY2hlZXJpby5sb2FkKGh0bWwpKHRhZykuZWFjaCgoaSwgZWwpID0+IHtcbiAgICAgIGxpbmtzW2ldID0geyB0YWcsIG9yaWdpbjogY2hlZXJpbyhlbCkuYXR0cihnZXRBdHRyTmFtZSh0YWcpKSB9O1xuICAgIH0pO1xuICAgIHJldHVybiBbLi4uYWNjLCAuLi5saW5rc107XG4gIH0sIFtdKTtcbiAgY29uc29sZS5sb2coZm91bmRMaW5rcyk7XG4gIGNvbnN0IGxpbmtzRm9yQ29tcGFyaXNvbiA9IGZvdW5kTGlua3NcbiAgICAubWFwKChsaW5rKSA9PiAoeyAuLi5saW5rLCBub3JtYWxpemVkOiBuZXcgVVJMKGxpbmsub3JpZ2luLCBiYXNlVXJsKSB9KSk7XG4gIGNvbnN0IGxvY2FsTGlua3MgPSBsaW5rc0ZvckNvbXBhcmlzb25cbiAgICAuZmlsdGVyKCh7IG5vcm1hbGl6ZWQsIG9yaWdpbiB9KSA9PiBvcmlnaW4gJiYgbm9ybWFsaXplZC5ob3N0ID09PSBiYXNlVXJsLmhvc3QpO1xuICByZXR1cm4gbG9jYWxMaW5rc1xuICAgIC5tYXAoKGl0ZW0pID0+ICh7IC4uLml0ZW0sIG5ld0ZpbGVQYXRoOiBnZXRGaWxlUGF0aChpdGVtLm5vcm1hbGl6ZWQsIGJhc2VVcmwpIH0pKTtcbn07XG5cbmNvbnN0IGdldE5ld0h0bWwgPSAoc291cmNlc0RhdGEsIGh0bWwpID0+IHtcbiAgY29uc3QgJCA9IGNoZWVyaW8ubG9hZChodG1sKTtcbiAgc291cmNlc0RhdGEuZm9yRWFjaCgoeyB0YWcsIG9yaWdpbiwgbmV3RmlsZVBhdGggfSkgPT4ge1xuICAgIGNvbnN0IGF0dHJOYW1lID0gZ2V0QXR0ck5hbWUodGFnKTtcbiAgICAkKGAke3RhZ31bJHthdHRyTmFtZX09XCIke29yaWdpbn1cIl1gKS5hdHRyKGF0dHJOYW1lLCBuZXdGaWxlUGF0aCk7XG4gIH0pO1xuICByZXR1cm4gJC5odG1sKCk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBhc3luYyAocmVxdWVzdFVybCwgZGlyID0gZGVmYXVsdERpcikgPT4ge1xuICBjb25zb2xlLmxvZyhgZGVmYXVsdERpcjogJHtkZWZhdWx0RGlyfWApO1xuICBjb25zb2xlLmxvZyhgRGlyOiAke2Rpcn1gKTtcbiAgY29uc3QgdXJsID0gbmV3IFVSTChyZXF1ZXN0VXJsKTtcbiAgY29uc3QgcGFnZU5hbWUgPSBnZXROYW1lKHVybCk7XG4gIGNvbnN0IGZpbGVwYXRoID0gYCR7ZGlyfS8ke3BhZ2VOYW1lfS5odG1sYDtcbiAgY29uc3QgZmlsZXNEaXJOYW1lID0gYCR7ZGlyfS8ke3BhZ2VOYW1lfV9maWxlc2A7XG4gIGxldCBodG1sO1xuICBsZXQgbmV3SHRtbDtcbiAgbGV0IGZpbGVzU291cmNlO1xuXG4gIHRyeSB7XG4gICAgZGVidWdDb21tb24oJ0dFVCAlcycsIHVybC5ocmVmKTsgLy8gZGVidWdIdHRwTWFpbignR0VUICVzJywgdXJsLmhyZWYpO1xuICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgYXhpb3MuZ2V0KHVybC5ocmVmKTtcbiAgICBodG1sID0gZGF0YTtcbiAgICBjb25zb2xlLmxvZyhodG1sKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBQYWdlTG9hZGVyTmV0RXJyb3IoZSwgdXJsLmhyZWYpO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBmaWxlc1NvdXJjZSA9IGdldFNvdXJjZXNJbmZvKGh0bWwsIHRhZ3MsIHVybCk7XG4gICAgY29uc29sZS5sb2coZmlsZXNTb3VyY2UpO1xuICAgIG5ld0h0bWwgPSBnZXROZXdIdG1sKGZpbGVzU291cmNlLCBodG1sKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHBhcnNlIGxvYWRlZCBkYXRhLiBXcml0ZSB1cywgcGxlYXNlJyk7XG4gIH1cblxuICB0cnkge1xuICAgIGF3YWl0IHByb21pc2VzLmFjY2VzcyhwYXRoLmRpcm5hbWUoZGlyKSk7XG4gICAgYXdhaXQgcHJvbWlzZXMubWtkaXIoZGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBQYWdlTG9hZGVyRnNFcnJvcihlLCBwYXRoLmRpcm5hbWUoZGlyKSk7XG4gIH1cblxuICB0cnkge1xuICAgIGRlYnVnQ29tbW9uKCdDcmVhdGUgZmlsZSAlcycsIGZpbGVwYXRoLCBkaXIpOyAvLyBkZWJ1Z0ZzKCdDcmVhdGUgZmlsZSAlcycsIGZpbGVwYXRoLCBkaXIpO1xuICAgIGF3YWl0IHByb21pc2VzLndyaXRlRmlsZShmaWxlcGF0aCwgbmV3SHRtbCwgJ3V0Zi04Jyk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgUGFnZUxvYWRlckZzRXJyb3IoZSwgZGlyKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgZGVidWdDb21tb24oJ0NyZWF0ZSBkaXJlY3RvcnkgJXMnLCBmaWxlc0Rpck5hbWUpOyAvLyBkZWJ1Z0ZzKCdDcmVhdGUgZGlyZWN0b3J5ICVzJywgZmlsZXNEaXJOYW1lKTtcbiAgICBhd2FpdCBwcm9taXNlcy5ta2RpcihmaWxlc0Rpck5hbWUsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IFBhZ2VMb2FkZXJGc0Vycm9yKGUsIGRpcik7XG4gIH1cblxuICBmaWxlc1NvdXJjZS5mb3JFYWNoKChpdGVtKSA9PiB7XG4gICAgY3JlYXRlRmlsZShpdGVtLm5vcm1hbGl6ZWQuaHJlZiwgYCR7ZGlyfS8ke2l0ZW0ubmV3RmlsZVBhdGh9YCk7XG4gIH0pO1xuICByZXR1cm4gZmlsZXBhdGg7XG59O1xuIl19