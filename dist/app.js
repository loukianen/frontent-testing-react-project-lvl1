"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _axios = _interopRequireDefault(require("axios"));

var _debug = _interopRequireDefault(require("debug"));

require("axios-debug-log");

var _promises = _interopRequireDefault(require("fs/promises"));

var _path = _interopRequireDefault(require("path"));

var _cheerio = _interopRequireDefault(require("cheerio"));

var _PageLoaderNetError = _interopRequireDefault(require("./errors/PageLoaderNetError"));

var _PageLoaderFsError = _interopRequireDefault(require("./errors/PageLoaderFsError"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const debugCommon = (0, _debug.default)('page-loader');
const tags = ['img', 'link', 'script'];

const createFile = async (source, filepath) => {
  let response;

  try {
    debugCommon('GET %s', source);

    const request = _axios.default.create({
      baseURL: source,
      method: 'GET',
      responseType: 'arraybuffer'
    });

    response = await request();
  } catch (e) {
    throw new _PageLoaderNetError.default(e, source);
  }

  try {
    debugCommon('Create source file %s', filepath);
    await _promises.default.writeFile(filepath, response.data);
    return true;
  } catch (e) {
    throw new _PageLoaderFsError.default(e, filepath);
  }
};

const getAttrName = tag => {
  switch (tag) {
    case 'img':
      return 'src';

    case 'link':
      return 'href';

    case 'script':
      return 'src';

    default:
      throw new Error('Unknown tag name');
  }
};

const getName = url => {
  const nameFromHostName = `${url.hostname.split('.').join('-')}`;
  const nameFromPath = url.pathname.length > 1 ? `${url.pathname.split('/').join('-')}` : '';
  return `${nameFromHostName}${nameFromPath}`;
};

const getFilePath = (sourceUrl, baseUrl) => {
  const name = `${getName(baseUrl)}_files/${getName(sourceUrl)}`;
  const isSourceDirectory = _path.default.extname(sourceUrl.href) === '';
  return isSourceDirectory ? `${name}.html` : name;
};

const getSourcesInfo = (html, tagNames, baseUrl) => {
  const foundLinks = tagNames.reduce((acc, tag) => {
    const links = [];

    _cheerio.default.load(html)(tag).each((i, el) => {
      links[i] = {
        tag,
        origin: (0, _cheerio.default)(el).attr(getAttrName(tag))
      };
    });

    return [...acc, ...links];
  }, []);
  const linksForComparison = foundLinks.map(link => ({ ...link,
    normalized: new URL(link.origin, baseUrl)
  }));
  const localLinks = linksForComparison.filter(({
    normalized,
    origin
  }) => origin && normalized.host === baseUrl.host);
  return localLinks.map(item => ({ ...item,
    newFilePath: getFilePath(item.normalized, baseUrl)
  }));
};

const getNewHtml = (sourcesData, html) => {
  const $ = _cheerio.default.load(html);

  sourcesData.forEach(({
    tag,
    origin,
    newFilePath
  }) => {
    const attrName = getAttrName(tag);
    $(`${tag}[${attrName}="${origin}"]`).attr(attrName, newFilePath);
  });
  return $.html();
};

var _default = async (requestUrl, dir) => {
  const url = new URL(requestUrl);
  const pageName = getName(url);
  const filepath = `${dir}/${pageName}.html`;
  const filesDirName = `${dir}/${pageName}_files`;
  let html;
  let newHtml;
  let filesSource;

  try {
    debugCommon('GET %s', url.href); // debugHttpMain('GET %s', url.href);

    const {
      data
    } = await _axios.default.get(url.href);
    html = data;
  } catch (e) {
    throw new _PageLoaderNetError.default(e, url.href);
  }

  try {
    filesSource = getSourcesInfo(html, tags, url);
    newHtml = getNewHtml(filesSource, html);
  } catch (e) {
    throw new Error('Failed to parse loaded data. Write us, please');
  }

  try {
    await _promises.default.access(_path.default.dirname(dir));
    await _promises.default.mkdir(dir, {
      recursive: true
    });
  } catch (e) {
    throw new _PageLoaderFsError.default(e, _path.default.dirname(dir));
  }

  try {
    debugCommon('Create file %s', filepath, dir); // debugFs('Create file %s', filepath, dir);

    await _promises.default.writeFile(filepath, newHtml, 'utf-8');
  } catch (e) {
    throw new _PageLoaderFsError.default(e, dir);
  }

  try {
    debugCommon('Create directory %s', filesDirName); // debugFs('Create directory %s', filesDirName);

    await _promises.default.mkdir(filesDirName, {
      recursive: true
    });
  } catch (e) {
    throw new _PageLoaderFsError.default(e, dir);
  }

  filesSource.forEach(item => {
    createFile(item.normalized.href, `${dir}/${item.newFilePath}`);
  });
  return filepath;
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAuanMiXSwibmFtZXMiOlsiZGVidWdDb21tb24iLCJ0YWdzIiwiY3JlYXRlRmlsZSIsInNvdXJjZSIsImZpbGVwYXRoIiwicmVzcG9uc2UiLCJyZXF1ZXN0IiwiYXhpb3MiLCJjcmVhdGUiLCJiYXNlVVJMIiwibWV0aG9kIiwicmVzcG9uc2VUeXBlIiwiZSIsIlBhZ2VMb2FkZXJOZXRFcnJvciIsImZzIiwid3JpdGVGaWxlIiwiZGF0YSIsIlBhZ2VMb2FkZXJGc0Vycm9yIiwiZ2V0QXR0ck5hbWUiLCJ0YWciLCJFcnJvciIsImdldE5hbWUiLCJ1cmwiLCJuYW1lRnJvbUhvc3ROYW1lIiwiaG9zdG5hbWUiLCJzcGxpdCIsImpvaW4iLCJuYW1lRnJvbVBhdGgiLCJwYXRobmFtZSIsImxlbmd0aCIsImdldEZpbGVQYXRoIiwic291cmNlVXJsIiwiYmFzZVVybCIsIm5hbWUiLCJpc1NvdXJjZURpcmVjdG9yeSIsInBhdGgiLCJleHRuYW1lIiwiaHJlZiIsImdldFNvdXJjZXNJbmZvIiwiaHRtbCIsInRhZ05hbWVzIiwiZm91bmRMaW5rcyIsInJlZHVjZSIsImFjYyIsImxpbmtzIiwiY2hlZXJpbyIsImxvYWQiLCJlYWNoIiwiaSIsImVsIiwib3JpZ2luIiwiYXR0ciIsImxpbmtzRm9yQ29tcGFyaXNvbiIsIm1hcCIsImxpbmsiLCJub3JtYWxpemVkIiwiVVJMIiwibG9jYWxMaW5rcyIsImZpbHRlciIsImhvc3QiLCJpdGVtIiwibmV3RmlsZVBhdGgiLCJnZXROZXdIdG1sIiwic291cmNlc0RhdGEiLCIkIiwiZm9yRWFjaCIsImF0dHJOYW1lIiwicmVxdWVzdFVybCIsImRpciIsInBhZ2VOYW1lIiwiZmlsZXNEaXJOYW1lIiwibmV3SHRtbCIsImZpbGVzU291cmNlIiwiZ2V0IiwiYWNjZXNzIiwiZGlybmFtZSIsIm1rZGlyIiwicmVjdXJzaXZlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7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LENBQXFCTCxJQUFELElBQVU7QUFDNUIxRCxJQUFBQSxVQUFVLENBQUMwRCxJQUFJLENBQUNMLFVBQUwsQ0FBZ0JsQixJQUFqQixFQUF3QixHQUFFK0IsR0FBSSxJQUFHUixJQUFJLENBQUNDLFdBQVksRUFBbEQsQ0FBVjtBQUNELEdBRkQ7QUFHQSxTQUFPekQsUUFBUDtBQUNELEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IGRlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCAnYXhpb3MtZGVidWctbG9nJztcbmltcG9ydCBmcyBmcm9tICdmcy9wcm9taXNlcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBjaGVlcmlvIGZyb20gJ2NoZWVyaW8nO1xuaW1wb3J0IFBhZ2VMb2FkZXJOZXRFcnJvciBmcm9tICcuL2Vycm9ycy9QYWdlTG9hZGVyTmV0RXJyb3InO1xuaW1wb3J0IFBhZ2VMb2FkZXJGc0Vycm9yIGZyb20gJy4vZXJyb3JzL1BhZ2VMb2FkZXJGc0Vycm9yJztcblxuY29uc3QgZGVidWdDb21tb24gPSBkZWJ1ZygncGFnZS1sb2FkZXInKTtcblxuY29uc3QgdGFncyA9IFsnaW1nJywgJ2xpbmsnLCAnc2NyaXB0J107XG5cbmNvbnN0IGNyZWF0ZUZpbGUgPSBhc3luYyAoc291cmNlLCBmaWxlcGF0aCkgPT4ge1xuICBsZXQgcmVzcG9uc2U7XG4gIHRyeSB7XG4gICAgZGVidWdDb21tb24oJ0dFVCAlcycsIHNvdXJjZSk7XG4gICAgY29uc3QgcmVxdWVzdCA9IGF4aW9zLmNyZWF0ZSh7XG4gICAgICBiYXNlVVJMOiBzb3VyY2UsXG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgcmVzcG9uc2VUeXBlOiAnYXJyYXlidWZmZXInLFxuICAgIH0pO1xuICAgIHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdCgpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IFBhZ2VMb2FkZXJOZXRFcnJvcihlLCBzb3VyY2UpO1xuICB9XG4gIHRyeSB7XG4gICAgZGVidWdDb21tb24oJ0NyZWF0ZSBzb3VyY2UgZmlsZSAlcycsIGZpbGVwYXRoKTtcbiAgICBhd2FpdCBmcy53cml0ZUZpbGUoZmlsZXBhdGgsIHJlc3BvbnNlLmRhdGEpO1xuICAgIHJldHVybiB0cnVlO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IFBhZ2VMb2FkZXJGc0Vycm9yKGUsIGZpbGVwYXRoKTtcbiAgfVxufTtcblxuY29uc3QgZ2V0QXR0ck5hbWUgPSAodGFnKSA9PiB7XG4gIHN3aXRjaCAodGFnKSB7XG4gICAgY2FzZSAnaW1nJzpcbiAgICAgIHJldHVybiAnc3JjJztcbiAgICBjYXNlICdsaW5rJzpcbiAgICAgIHJldHVybiAnaHJlZic7XG4gICAgY2FzZSAnc2NyaXB0JzpcbiAgICAgIHJldHVybiAnc3JjJztcbiAgICBkZWZhdWx0OlxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHRhZyBuYW1lJyk7XG4gIH1cbn07XG5cbmNvbnN0IGdldE5hbWUgPSAodXJsKSA9PiB7XG4gIGNvbnN0IG5hbWVGcm9tSG9zdE5hbWUgPSBgJHt1cmwuaG9zdG5hbWUuc3BsaXQoJy4nKS5qb2luKCctJyl9YDtcbiAgY29uc3QgbmFtZUZyb21QYXRoID0gdXJsLnBhdGhuYW1lLmxlbmd0aCA+IDEgPyBgJHt1cmwucGF0aG5hbWUuc3BsaXQoJy8nKS5qb2luKCctJyl9YCA6ICcnO1xuICByZXR1cm4gYCR7bmFtZUZyb21Ib3N0TmFtZX0ke25hbWVGcm9tUGF0aH1gO1xufTtcblxuY29uc3QgZ2V0RmlsZVBhdGggPSAoc291cmNlVXJsLCBiYXNlVXJsKSA9PiB7XG4gIGNvbnN0IG5hbWUgPSBgJHtnZXROYW1lKGJhc2VVcmwpfV9maWxlcy8ke2dldE5hbWUoc291cmNlVXJsKX1gO1xuICBjb25zdCBpc1NvdXJjZURpcmVjdG9yeSA9IHBhdGguZXh0bmFtZShzb3VyY2VVcmwuaHJlZikgPT09ICcnO1xuICByZXR1cm4gaXNTb3VyY2VEaXJlY3RvcnkgPyBgJHtuYW1lfS5odG1sYCA6IG5hbWU7XG59O1xuXG5jb25zdCBnZXRTb3VyY2VzSW5mbyA9IChodG1sLCB0YWdOYW1lcywgYmFzZVVybCkgPT4ge1xuICBjb25zdCBmb3VuZExpbmtzID0gdGFnTmFtZXMucmVkdWNlKChhY2MsIHRhZykgPT4ge1xuICAgIGNvbnN0IGxpbmtzID0gW107XG4gICAgY2hlZXJpby5sb2FkKGh0bWwpKHRhZykuZWFjaCgoaSwgZWwpID0+IHtcbiAgICAgIGxpbmtzW2ldID0geyB0YWcsIG9yaWdpbjogY2hlZXJpbyhlbCkuYXR0cihnZXRBdHRyTmFtZSh0YWcpKSB9O1xuICAgIH0pO1xuICAgIHJldHVybiBbLi4uYWNjLCAuLi5saW5rc107XG4gIH0sIFtdKTtcbiAgY29uc3QgbGlua3NGb3JDb21wYXJpc29uID0gZm91bmRMaW5rc1xuICAgIC5tYXAoKGxpbmspID0+ICh7IC4uLmxpbmssIG5vcm1hbGl6ZWQ6IG5ldyBVUkwobGluay5vcmlnaW4sIGJhc2VVcmwpIH0pKTtcbiAgY29uc3QgbG9jYWxMaW5rcyA9IGxpbmtzRm9yQ29tcGFyaXNvblxuICAgIC5maWx0ZXIoKHsgbm9ybWFsaXplZCwgb3JpZ2luIH0pID0+IG9yaWdpbiAmJiBub3JtYWxpemVkLmhvc3QgPT09IGJhc2VVcmwuaG9zdCk7XG4gIHJldHVybiBsb2NhbExpbmtzXG4gICAgLm1hcCgoaXRlbSkgPT4gKHsgLi4uaXRlbSwgbmV3RmlsZVBhdGg6IGdldEZpbGVQYXRoKGl0ZW0ubm9ybWFsaXplZCwgYmFzZVVybCkgfSkpO1xufTtcblxuY29uc3QgZ2V0TmV3SHRtbCA9IChzb3VyY2VzRGF0YSwgaHRtbCkgPT4ge1xuICBjb25zdCAkID0gY2hlZXJpby5sb2FkKGh0bWwpO1xuICBzb3VyY2VzRGF0YS5mb3JFYWNoKCh7IHRhZywgb3JpZ2luLCBuZXdGaWxlUGF0aCB9KSA9PiB7XG4gICAgY29uc3QgYXR0ck5hbWUgPSBnZXRBdHRyTmFtZSh0YWcpO1xuICAgICQoYCR7dGFnfVske2F0dHJOYW1lfT1cIiR7b3JpZ2lufVwiXWApLmF0dHIoYXR0ck5hbWUsIG5ld0ZpbGVQYXRoKTtcbiAgfSk7XG4gIHJldHVybiAkLmh0bWwoKTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jIChyZXF1ZXN0VXJsLCBkaXIpID0+IHtcbiAgY29uc3QgdXJsID0gbmV3IFVSTChyZXF1ZXN0VXJsKTtcbiAgY29uc3QgcGFnZU5hbWUgPSBnZXROYW1lKHVybCk7XG4gIGNvbnN0IGZpbGVwYXRoID0gYCR7ZGlyfS8ke3BhZ2VOYW1lfS5odG1sYDtcbiAgY29uc3QgZmlsZXNEaXJOYW1lID0gYCR7ZGlyfS8ke3BhZ2VOYW1lfV9maWxlc2A7XG4gIGxldCBodG1sO1xuICBsZXQgbmV3SHRtbDtcbiAgbGV0IGZpbGVzU291cmNlO1xuXG4gIHRyeSB7XG4gICAgZGVidWdDb21tb24oJ0dFVCAlcycsIHVybC5ocmVmKTsgLy8gZGVidWdIdHRwTWFpbignR0VUICVzJywgdXJsLmhyZWYpO1xuICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgYXhpb3MuZ2V0KHVybC5ocmVmKTtcbiAgICBodG1sID0gZGF0YTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBQYWdlTG9hZGVyTmV0RXJyb3IoZSwgdXJsLmhyZWYpO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBmaWxlc1NvdXJjZSA9IGdldFNvdXJjZXNJbmZvKGh0bWwsIHRhZ3MsIHVybCk7XG4gICAgbmV3SHRtbCA9IGdldE5ld0h0bWwoZmlsZXNTb3VyY2UsIGh0bWwpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gcGFyc2UgbG9hZGVkIGRhdGEuIFdyaXRlIHVzLCBwbGVhc2UnKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgYXdhaXQgZnMuYWNjZXNzKHBhdGguZGlybmFtZShkaXIpKTtcbiAgICBhd2FpdCBmcy5ta2RpcihkaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IFBhZ2VMb2FkZXJGc0Vycm9yKGUsIHBhdGguZGlybmFtZShkaXIpKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgZGVidWdDb21tb24oJ0NyZWF0ZSBmaWxlICVzJywgZmlsZXBhdGgsIGRpcik7IC8vIGRlYnVnRnMoJ0NyZWF0ZSBmaWxlICVzJywgZmlsZXBhdGgsIGRpcik7XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKGZpbGVwYXRoLCBuZXdIdG1sLCAndXRmLTgnKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBQYWdlTG9hZGVyRnNFcnJvcihlLCBkaXIpO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBkZWJ1Z0NvbW1vbignQ3JlYXRlIGRpcmVjdG9yeSAlcycsIGZpbGVzRGlyTmFtZSk7IC8vIGRlYnVnRnMoJ0NyZWF0ZSBkaXJlY3RvcnkgJXMnLCBmaWxlc0Rpck5hbWUpO1xuICAgIGF3YWl0IGZzLm1rZGlyKGZpbGVzRGlyTmFtZSwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgUGFnZUxvYWRlckZzRXJyb3IoZSwgZGlyKTtcbiAgfVxuXG4gIGZpbGVzU291cmNlLmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICBjcmVhdGVGaWxlKGl0ZW0ubm9ybWFsaXplZC5ocmVmLCBgJHtkaXJ9LyR7aXRlbS5uZXdGaWxlUGF0aH1gKTtcbiAgfSk7XG4gIHJldHVybiBmaWxlcGF0aDtcbn07XG4iXX0=