"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _axios = _interopRequireDefault(require("axios"));

var _debug = _interopRequireDefault(require("debug"));

require("axios-debug-log");

var _fs = _interopRequireDefault(require("fs"));

var _promises = _interopRequireDefault(require("fs/promises"));

var _path = _interopRequireDefault(require("path"));

var _cheerio = _interopRequireDefault(require("cheerio"));

var _PageLoaderNetError = _interopRequireDefault(require("./errors/PageLoaderNetError"));

var _PageLoaderFsError = _interopRequireDefault(require("./errors/PageLoaderFsError"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const debugCommon = (0, _debug.default)('page-loader');
const defaultDir = process.cwd();
const tags = ['img', 'link', 'script'];

const createFile = async (source, filepath) => {
  let response;

  try {
    debugCommon('GET %s', source);

    const request = _axios.default.create({
      baseURL: source,
      method: 'GET',
      responseType: 'stream'
    });

    response = await request();
  } catch (e) {
    throw new _PageLoaderNetError.default(e, source);
  }

  try {
    debugCommon('Create source file %s', filepath);
    await response.data.pipe(_fs.default.createWriteStream(filepath));
    return true;
  } catch (e) {
    throw new _PageLoaderFsError.default(e, filepath);
  }
};

const getAttrName = tag => {
  switch (tag) {
    case 'img':
      return 'src';

    case 'link':
      return 'href';

    case 'script':
      return 'src';

    default:
      throw new Error('Unknown tag name');
  }
};

const getName = url => {
  const nameFromHostName = `${url.hostname.split('.').join('-')}`;
  const nameFromPath = url.pathname.length > 1 ? `${url.pathname.split('/').join('-')}` : '';
  return `${nameFromHostName}${nameFromPath}`;
};

const getFilePath = (sourceUrl, baseUrl) => {
  const name = `${getName(baseUrl)}_files/${getName(sourceUrl)}`;
  const isSourceDirectory = _path.default.extname(sourceUrl.href) === '';
  return isSourceDirectory ? `${name}.html` : name;
};

const getSourcesInfo = (html, tagNames, baseUrl) => {
  const foundLinks = tagNames.reduce((acc, tag) => {
    const links = [];

    _cheerio.default.load(html)(tag).each((i, el) => {
      links[i] = {
        tag,
        origin: (0, _cheerio.default)(el).attr(getAttrName(tag))
      };
    });

    return [...acc, ...links];
  }, []);
  const linksForComparison = foundLinks.map(link => ({ ...link,
    normalized: new URL(link.origin, baseUrl)
  }));
  const localLinks = linksForComparison.filter(({
    normalized,
    origin
  }) => origin && normalized.host === baseUrl.host);
  return localLinks.map(item => ({ ...item,
    newFilePath: getFilePath(item.normalized, baseUrl)
  }));
};

const getNewHtml = (sourcesData, html) => {
  const $ = _cheerio.default.load(html);

  sourcesData.forEach(({
    tag,
    origin,
    newFilePath
  }) => {
    const attrName = getAttrName(tag);
    $(`${tag}[${attrName}="${origin}"]`).attr(attrName, newFilePath);
  });
  return $.html();
};

var _default = async (requestUrl, dir = defaultDir) => {
  const url = new URL(requestUrl);
  const pageName = getName(url);
  const filepath = `${dir}/${pageName}.html`;
  const filesDirName = `${dir}/${pageName}_files`;
  let html;
  let newHtml;
  let filesSource;

  try {
    debugCommon('GET %s', url.href); // debugHttpMain('GET %s', url.href);

    const {
      data
    } = await _axios.default.get(url.href);
    html = data;
  } catch (e) {
    throw new _PageLoaderNetError.default(e, url.href);
  }

  try {
    filesSource = getSourcesInfo(html, tags, url);
    newHtml = getNewHtml(filesSource, html);
  } catch (e) {
    throw new Error('Failed to parse loaded data. Write us, please');
  }

  try {
    await _promises.default.access(_path.default.dirname(dir));
    await _promises.default.mkdir(dir, {
      recursive: true
    });
  } catch (e) {
    throw new _PageLoaderFsError.default(e, _path.default.dirname(dir));
  }

  try {
    debugCommon('Create file %s', filepath, dir); // debugFs('Create file %s', filepath, dir);

    await _promises.default.writeFile(filepath, newHtml, 'utf-8');
  } catch (e) {
    throw new _PageLoaderFsError.default(e, dir);
  }

  try {
    debugCommon('Create directory %s', filesDirName); // debugFs('Create directory %s', filesDirName);

    await _promises.default.mkdir(filesDirName, {
      recursive: true
    });
  } catch (e) {
    throw new _PageLoaderFsError.default(e, dir);
  }

  filesSource.forEach(item => {
    createFile(item.normalized.href, `${dir}/${item.newFilePath}`);
  });
  return filepath;
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2FwcC9hcHAuanMiXSwibmFtZXMiOlsiZGVidWdDb21tb24iLCJkZWZhdWx0RGlyIiwicHJvY2VzcyIsImN3ZCIsInRhZ3MiLCJjcmVhdGVGaWxlIiwic291cmNlIiwiZmlsZXBhdGgiLCJyZXNwb25zZSIsInJlcXVlc3QiLCJheGlvcyIsImNyZWF0ZSIsImJhc2VVUkwiLCJtZXRob2QiLCJyZXNwb25zZVR5cGUiLCJlIiwiUGFnZUxvYWRlck5ldEVycm9yIiwiZGF0YSIsInBpcGUiLCJmcyIsImNyZWF0ZVdyaXRlU3RyZWFtIiwiUGFnZUxvYWRlckZzRXJyb3IiLCJnZXRBdHRyTmFtZSIsInRhZyIsIkVycm9yIiwiZ2V0TmFtZSIsInVybCIsIm5hbWVGcm9tSG9zdE5hbWUiLCJob3N0bmFtZSIsInNwbGl0Iiwiam9pbiIsIm5hbWVGcm9tUGF0aCIsInBhdGhuYW1lIiwibGVuZ3RoIiwiZ2V0RmlsZVBhdGgiLCJzb3VyY2VVcmwiLCJiYXNlVXJsIiwibmFtZSIsImlzU291cmNlRGlyZWN0b3J5IiwicGF0aCIsImV4dG5hbWUiLCJocmVmIiwiZ2V0U291cmNlc0luZm8iLCJodG1sIiwidGFnTmFtZXMiLCJmb3VuZExpbmtzIiwicmVkdWNlIiwiYWNjIiwibGlua3MiLCJjaGVlcmlvIiwibG9hZCIsImVhY2giLCJpIiwiZWwiLCJvcmlnaW4iLCJhdHRyIiwibGlua3NGb3JDb21wYXJpc29uIiwibWFwIiwibGluayIsIm5vcm1hbGl6ZWQiLCJVUkwiLCJsb2NhbExpbmtzIiwiZmlsdGVyIiwiaG9zdCIsIml0ZW0iLCJuZXdGaWxlUGF0aCIsImdldE5ld0h0bWwiLCJzb3VyY2VzRGF0YSIsIiQiLCJmb3JFYWNoIiwiYXR0ck5hbWUiLCJyZXF1ZXN0VXJsIiwiZGlyIiwicGFnZU5hbWUiLCJmaWxlc0Rpck5hbWUiLCJuZXdIdG1sIiwiZmlsZXNTb3VyY2UiLCJnZXQiLCJwcm9taXNlcyIsImFjY2VzcyIsImRpcm5hbWUiLCJta2RpciIsInJlY3Vyc2l2ZSIs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QUFBLFNBQVMsRUFBRTtBQUFiLEtBQTdCLENBQU47QUFDRCxHQUhELENBR0UsT0FBT25FLENBQVAsRUFBVTtBQUNWLFVBQU0sSUFBSU0sMEJBQUosQ0FBc0JOLENBQXRCLEVBQXlCeUQsR0FBekIsQ0FBTjtBQUNEOztBQUVESSxFQUFBQSxXQUFXLENBQUNQLE9BQVosQ0FBcUJMLElBQUQsSUFBVTtBQUM1QjNELElBQUFBLFVBQVUsQ0FBQzJELElBQUksQ0FBQ0wsVUFBTCxDQUFnQmxCLElBQWpCLEVBQXdCLEdBQUUrQixHQUFJLElBQUdSLElBQUksQ0FBQ0MsV0FBWSxFQUFsRCxDQUFWO0FBQ0QsR0FGRDtBQUdBLFNBQU8xRCxRQUFQO0FBQ0QsQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBheGlvcyBmcm9tICdheGlvcyc7XG5pbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0ICdheGlvcy1kZWJ1Zy1sb2cnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBwcm9taXNlcyBmcm9tICdmcy9wcm9taXNlcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBjaGVlcmlvIGZyb20gJ2NoZWVyaW8nO1xuaW1wb3J0IFBhZ2VMb2FkZXJOZXRFcnJvciBmcm9tICcuL2Vycm9ycy9QYWdlTG9hZGVyTmV0RXJyb3InO1xuaW1wb3J0IFBhZ2VMb2FkZXJGc0Vycm9yIGZyb20gJy4vZXJyb3JzL1BhZ2VMb2FkZXJGc0Vycm9yJztcblxuY29uc3QgZGVidWdDb21tb24gPSBkZWJ1ZygncGFnZS1sb2FkZXInKTtcblxuY29uc3QgZGVmYXVsdERpciA9IHByb2Nlc3MuY3dkKCk7XG5jb25zdCB0YWdzID0gWydpbWcnLCAnbGluaycsICdzY3JpcHQnXTtcblxuY29uc3QgY3JlYXRlRmlsZSA9IGFzeW5jIChzb3VyY2UsIGZpbGVwYXRoKSA9PiB7XG4gIGxldCByZXNwb25zZTtcbiAgdHJ5IHtcbiAgICBkZWJ1Z0NvbW1vbignR0VUICVzJywgc291cmNlKTtcbiAgICBjb25zdCByZXF1ZXN0ID0gYXhpb3MuY3JlYXRlKHtcbiAgICAgIGJhc2VVUkw6IHNvdXJjZSxcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICByZXNwb25zZVR5cGU6ICdzdHJlYW0nLFxuICAgIH0pO1xuICAgIHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdCgpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IFBhZ2VMb2FkZXJOZXRFcnJvcihlLCBzb3VyY2UpO1xuICB9XG4gIHRyeSB7XG4gICAgZGVidWdDb21tb24oJ0NyZWF0ZSBzb3VyY2UgZmlsZSAlcycsIGZpbGVwYXRoKTtcbiAgICBhd2FpdCByZXNwb25zZS5kYXRhLnBpcGUoZnMuY3JlYXRlV3JpdGVTdHJlYW0oZmlsZXBhdGgpKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBQYWdlTG9hZGVyRnNFcnJvcihlLCBmaWxlcGF0aCk7XG4gIH1cbn07XG5cbmNvbnN0IGdldEF0dHJOYW1lID0gKHRhZykgPT4ge1xuICBzd2l0Y2ggKHRhZykge1xuICAgIGNhc2UgJ2ltZyc6XG4gICAgICByZXR1cm4gJ3NyYyc7XG4gICAgY2FzZSAnbGluayc6XG4gICAgICByZXR1cm4gJ2hyZWYnO1xuICAgIGNhc2UgJ3NjcmlwdCc6XG4gICAgICByZXR1cm4gJ3NyYyc7XG4gICAgZGVmYXVsdDpcbiAgICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biB0YWcgbmFtZScpO1xuICB9XG59O1xuXG5jb25zdCBnZXROYW1lID0gKHVybCkgPT4ge1xuICBjb25zdCBuYW1lRnJvbUhvc3ROYW1lID0gYCR7dXJsLmhvc3RuYW1lLnNwbGl0KCcuJykuam9pbignLScpfWA7XG4gIGNvbnN0IG5hbWVGcm9tUGF0aCA9IHVybC5wYXRobmFtZS5sZW5ndGggPiAxID8gYCR7dXJsLnBhdGhuYW1lLnNwbGl0KCcvJykuam9pbignLScpfWAgOiAnJztcbiAgcmV0dXJuIGAke25hbWVGcm9tSG9zdE5hbWV9JHtuYW1lRnJvbVBhdGh9YDtcbn07XG5cbmNvbnN0IGdldEZpbGVQYXRoID0gKHNvdXJjZVVybCwgYmFzZVVybCkgPT4ge1xuICBjb25zdCBuYW1lID0gYCR7Z2V0TmFtZShiYXNlVXJsKX1fZmlsZXMvJHtnZXROYW1lKHNvdXJjZVVybCl9YDtcbiAgY29uc3QgaXNTb3VyY2VEaXJlY3RvcnkgPSBwYXRoLmV4dG5hbWUoc291cmNlVXJsLmhyZWYpID09PSAnJztcbiAgcmV0dXJuIGlzU291cmNlRGlyZWN0b3J5ID8gYCR7bmFtZX0uaHRtbGAgOiBuYW1lO1xufTtcblxuY29uc3QgZ2V0U291cmNlc0luZm8gPSAoaHRtbCwgdGFnTmFtZXMsIGJhc2VVcmwpID0+IHtcbiAgY29uc3QgZm91bmRMaW5rcyA9IHRhZ05hbWVzLnJlZHVjZSgoYWNjLCB0YWcpID0+IHtcbiAgICBjb25zdCBsaW5rcyA9IFtdO1xuICAgIGNoZWVyaW8ubG9hZChodG1sKSh0YWcpLmVhY2goKGksIGVsKSA9PiB7XG4gICAgICBsaW5rc1tpXSA9IHsgdGFnLCBvcmlnaW46IGNoZWVyaW8oZWwpLmF0dHIoZ2V0QXR0ck5hbWUodGFnKSkgfTtcbiAgICB9KTtcbiAgICByZXR1cm4gWy4uLmFjYywgLi4ubGlua3NdO1xuICB9LCBbXSk7XG4gIGNvbnN0IGxpbmtzRm9yQ29tcGFyaXNvbiA9IGZvdW5kTGlua3NcbiAgICAubWFwKChsaW5rKSA9PiAoeyAuLi5saW5rLCBub3JtYWxpemVkOiBuZXcgVVJMKGxpbmsub3JpZ2luLCBiYXNlVXJsKSB9KSk7XG4gIGNvbnN0IGxvY2FsTGlua3MgPSBsaW5rc0ZvckNvbXBhcmlzb25cbiAgICAuZmlsdGVyKCh7IG5vcm1hbGl6ZWQsIG9yaWdpbiB9KSA9PiBvcmlnaW4gJiYgbm9ybWFsaXplZC5ob3N0ID09PSBiYXNlVXJsLmhvc3QpO1xuICByZXR1cm4gbG9jYWxMaW5rc1xuICAgIC5tYXAoKGl0ZW0pID0+ICh7IC4uLml0ZW0sIG5ld0ZpbGVQYXRoOiBnZXRGaWxlUGF0aChpdGVtLm5vcm1hbGl6ZWQsIGJhc2VVcmwpIH0pKTtcbn07XG5cbmNvbnN0IGdldE5ld0h0bWwgPSAoc291cmNlc0RhdGEsIGh0bWwpID0+IHtcbiAgY29uc3QgJCA9IGNoZWVyaW8ubG9hZChodG1sKTtcbiAgc291cmNlc0RhdGEuZm9yRWFjaCgoeyB0YWcsIG9yaWdpbiwgbmV3RmlsZVBhdGggfSkgPT4ge1xuICAgIGNvbnN0IGF0dHJOYW1lID0gZ2V0QXR0ck5hbWUodGFnKTtcbiAgICAkKGAke3RhZ31bJHthdHRyTmFtZX09XCIke29yaWdpbn1cIl1gKS5hdHRyKGF0dHJOYW1lLCBuZXdGaWxlUGF0aCk7XG4gIH0pO1xuICByZXR1cm4gJC5odG1sKCk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBhc3luYyAocmVxdWVzdFVybCwgZGlyID0gZGVmYXVsdERpcikgPT4ge1xuICBjb25zdCB1cmwgPSBuZXcgVVJMKHJlcXVlc3RVcmwpO1xuICBjb25zdCBwYWdlTmFtZSA9IGdldE5hbWUodXJsKTtcbiAgY29uc3QgZmlsZXBhdGggPSBgJHtkaXJ9LyR7cGFnZU5hbWV9Lmh0bWxgO1xuICBjb25zdCBmaWxlc0Rpck5hbWUgPSBgJHtkaXJ9LyR7cGFnZU5hbWV9X2ZpbGVzYDtcbiAgbGV0IGh0bWw7XG4gIGxldCBuZXdIdG1sO1xuICBsZXQgZmlsZXNTb3VyY2U7XG5cbiAgdHJ5IHtcbiAgICBkZWJ1Z0NvbW1vbignR0VUICVzJywgdXJsLmhyZWYpOyAvLyBkZWJ1Z0h0dHBNYWluKCdHRVQgJXMnLCB1cmwuaHJlZik7XG4gICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCBheGlvcy5nZXQodXJsLmhyZWYpO1xuICAgIGh0bWwgPSBkYXRhO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IFBhZ2VMb2FkZXJOZXRFcnJvcihlLCB1cmwuaHJlZik7XG4gIH1cblxuICB0cnkge1xuICAgIGZpbGVzU291cmNlID0gZ2V0U291cmNlc0luZm8oaHRtbCwgdGFncywgdXJsKTtcbiAgICBuZXdIdG1sID0gZ2V0TmV3SHRtbChmaWxlc1NvdXJjZSwgaHRtbCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBwYXJzZSBsb2FkZWQgZGF0YS4gV3JpdGUgdXMsIHBsZWFzZScpO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBhd2FpdCBwcm9taXNlcy5hY2Nlc3MocGF0aC5kaXJuYW1lKGRpcikpO1xuICAgIGF3YWl0IHByb21pc2VzLm1rZGlyKGRpciwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgUGFnZUxvYWRlckZzRXJyb3IoZSwgcGF0aC5kaXJuYW1lKGRpcikpO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBkZWJ1Z0NvbW1vbignQ3JlYXRlIGZpbGUgJXMnLCBmaWxlcGF0aCwgZGlyKTsgLy8gZGVidWdGcygnQ3JlYXRlIGZpbGUgJXMnLCBmaWxlcGF0aCwgZGlyKTtcbiAgICBhd2FpdCBwcm9taXNlcy53cml0ZUZpbGUoZmlsZXBhdGgsIG5ld0h0bWwsICd1dGYtOCcpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IFBhZ2VMb2FkZXJGc0Vycm9yKGUsIGRpcik7XG4gIH1cblxuICB0cnkge1xuICAgIGRlYnVnQ29tbW9uKCdDcmVhdGUgZGlyZWN0b3J5ICVzJywgZmlsZXNEaXJOYW1lKTsgLy8gZGVidWdGcygnQ3JlYXRlIGRpcmVjdG9yeSAlcycsIGZpbGVzRGlyTmFtZSk7XG4gICAgYXdhaXQgcHJvbWlzZXMubWtkaXIoZmlsZXNEaXJOYW1lLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBQYWdlTG9hZGVyRnNFcnJvcihlLCBkaXIpO1xuICB9XG5cbiAgZmlsZXNTb3VyY2UuZm9yRWFjaCgoaXRlbSkgPT4ge1xuICAgIGNyZWF0ZUZpbGUoaXRlbS5ub3JtYWxpemVkLmhyZWYsIGAke2Rpcn0vJHtpdGVtLm5ld0ZpbGVQYXRofWApO1xuICB9KTtcbiAgcmV0dXJuIGZpbGVwYXRoO1xufTtcbiJdfQ==